@page
@model digioz.Portal.Pages.Chat.IndexModel
@using System.Text.Encodings.Web
@{
    ViewData["Title"] = "Chat";
    var enc = HtmlEncoder.Default;
}

<h2>Chat</h2>
<div class="mb-2 small text-muted">Signed in as: <strong>@Model.CurrentDisplayName</strong></div>

<div class="card mb-3">
    <div class="card-body p-2" style="max-height:350px; overflow-y:auto;" id="chatContainer">
        <ul id="messagesList" class="list-unstyled mb-0">
            @foreach (var m in Model.History)
            {
                var ts = m.Timestamp.HasValue ? m.Timestamp.Value.ToLocalTime().ToString("h:mm:ss tt") : "--";
                string displayName = "Anonymous";
                if (Model.DisplayNames.TryGetValue(m.UserId, out var name) && name != null)
                {
                    displayName = name;
                }
                <li>
                    <span class="text-secondary" style="font-size:.7rem">@ts</span>
                    <strong>@enc.Encode(displayName)</strong>: @enc.Encode(m.Message)
                </li>
            }
        </ul>
    </div>
</div>

<form id="chatForm" class="d-flex gap-2" autocomplete="off">
    <input id="messageInput" class="form-control" placeholder="Type message..." />
    <button id="sendButton" type="submit" class="btn btn-primary" disabled>Send</button>
</form>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const form = document.getElementById('chatForm');
        const input = document.getElementById('messageInput');
        const list = document.getElementById('messagesList');
        const container = document.getElementById('chatContainer');
        const sendBtn = document.getElementById('sendButton');
        function escapeHtml(str) { return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        const connection = new signalR.HubConnectionBuilder().withUrl('/chatHub').withAutomaticReconnect().build();
        connection.on('ReceiveMessage', (displayName, message) => {
            const li = document.createElement('li');
            li.innerHTML = `<span class=\"text-secondary\" style=\"font-size:.7rem\">${new Date().toLocaleTimeString()}</span> <strong>${escapeHtml(displayName)}</strong>: ${escapeHtml(message)}`;
            list.appendChild(li);
            container.scrollTop = container.scrollHeight;
        });
        connection.start().then(() => { 
            sendBtn.disabled = false; 
            input.focus(); 
            // Scroll to bottom on load
            container.scrollTop = container.scrollHeight;
        }).catch(err => console.error(err));
        form.addEventListener('submit', e => {
            e.preventDefault();
            const msg = input.value.trim();
            if(!msg) return;
            connection.invoke('SendMessage', msg).catch(err => console.error(err));
            input.value=''; input.focus();
        });
    </script>
}