@page "{id:int}"
@model DetailsModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Picture Details";
}

<div class="container my-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            @if (Model.Item != null)
            {
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h1 class="card-title mb-4">Picture Details</h1>

                        @if (!string.IsNullOrEmpty(Model.StatusMessage))
                        {
                            <div class="alert alert-@(Model.IsSuccess ? "success" : "danger") alert-dismissible fade show" role="alert">
                                @Model.StatusMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }

                        <div class="mb-4">
                            <div class="border rounded p-3 bg-light text-center position-relative" style="overflow: hidden;" id="imageContainer" title="Click to zoom in">
                                <img src="/img/Pictures/Full/@Model.Item.Filename" 
                                     alt="@Model.Item.Description" 
                                     class="img-fluid" 
                                     id="detailImage"
                                     style="max-width: 100%; max-height: 600px; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in;" />
                                <small class="text-muted d-block mt-2">Click image to zoom</small>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted">Description</h6>
                                <p class="lead">@Model.Item.Description</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Album</h6>
                                @if (Model.Album != null)
                                {
                                    <p class="lead">
                                        <a href="/Pictures/Album?id=@Model.Item.AlbumId">@Model.Album.Name</a>
                                    </p>
                                }
                                else
                                {
                                    <p class="lead">-</p>
                                }
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted">Uploaded By</h6>
                                @if (Model.UploaderProfile != null)
                                {
                                    <p class="lead">
                                        <i class="bi bi-person-circle"></i> 
                                        @if (!string.IsNullOrEmpty(Model.UploaderProfile.DisplayName))
                                        {
                                            @Model.UploaderProfile.DisplayName
                                        }
                                        else if (!string.IsNullOrEmpty(Model.UploaderProfile.FirstName) || !string.IsNullOrEmpty(Model.UploaderProfile.LastName))
                                        {
                                            @($"{Model.UploaderProfile.FirstName} {Model.UploaderProfile.LastName}".Trim())
                                        }
                                        else
                                        {
                                            <text>Anonymous User</text>
                                        }
                                    </p>
                                }
                                else
                                {
                                    <p class="lead"><i class="bi bi-person-circle"></i> Anonymous User</p>
                                }
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Date Uploaded</h6>
                                <p class="lead">@Model.Item.Timestamp?.ToLocalTime().ToString("MMMM dd, yyyy HH:mm")</p>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-muted">Status</h6>
                                <p class="lead">
                                    @if (Model.Item.Approved)
                                    {
                                        <span class="badge bg-success">Approved</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Pending Approval</span>
                                    }
                                    @if (Model.Item.Visible)
                                    {
                                        <span class="badge bg-info">Visible</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Hidden</span>
                                    }
                                </p>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <a href="/Pictures/List" class="btn btn-secondary">Back to Gallery</a>
                            @if (Model.IsOwner || User?.IsInRole("Admin") == true)
                            {
                                <a asp-page="Edit" asp-route-id="@Model.Item.Id" class="btn btn-primary">Edit</a>
                                <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Item.Id" style="display: inline;">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this picture?');">Delete</button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning">Picture not found.</div>
            }
        </div>
    </div>
</div>

<!-- Full Size Image Modal -->
<div class="modal fade" id="zoomModal" tabindex="-1" aria-labelledby="zoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-dark border-secondary">
                <h5 class="modal-title text-light" id="zoomModalLabel">@Model.Item?.Description</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-dark p-0 d-flex align-items-center justify-content-center" id="zoomContainer" style="height: calc(100vh - 120px); overflow: auto;">
                <img id="zoomImage" 
                     src="/img/Pictures/Full/@Model.Item?.Filename" 
                     alt="@Model.Item?.Description"
                     style="max-width: 100%; height: auto; cursor: zoom-out;" 
                     class="img-fluid clickable-image" />
            </div>
            <div class="modal-footer bg-dark border-secondary">
                <small class="text-muted">Full size image | Click to close | Press Esc to close</small>
            </div>
        </div>
    </div>
</div>

<style>
    #detailImage {
        cursor: zoom-in;
    }

    #detailImage:hover {
        opacity: 0.9;
    }

    #zoomContainer {
        background-color: #1a1a1a;
    }

    #zoomImage {
        max-width: 100%;
        height: auto;
        width: 100%;
        cursor: zoom-out;
    }

    #zoomImage:hover {
        opacity: 0.95;
    }

    .clickable-image {
        cursor: zoom-out !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageContainer = document.getElementById('imageContainer');
        const detailImage = document.getElementById('detailImage');
        const zoomModal = document.getElementById('zoomModal');
        const zoomImage = document.getElementById('zoomImage');
        const closeButton = document.querySelector('[data-bs-dismiss="modal"]');
        
        // Open modal on image click
        if (imageContainer && zoomModal) {
            imageContainer.addEventListener('click', function(e) {
                e.preventDefault();
                const modal = new bootstrap.Modal(zoomModal);
                modal.show();
            });
        }
        
        // Close modal when clicking on the zoomed image
        if (zoomImage && zoomModal) {
            zoomImage.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = bootstrap.Modal.getInstance(zoomModal);
                if (modal) {
                    modal.hide();
                }
            });
        }
        
        // Clean up backdrop after modal closes
        if (zoomModal) {
            zoomModal.addEventListener('hidden.bs.modal', function() {
                setTimeout(function() {
                    // Remove all modal backdrops that might be lingering
                    document.querySelectorAll('.modal-backdrop').forEach(function(backdrop) {
                        backdrop.remove();
                    });
                    
                    // Restore body overflow and remove modal-open class
                    document.body.style.overflow = '';
                    document.body.classList.remove('modal-open');
                    
                    // Remove padding added by Bootstrap for scrollbar compensation
                    document.body.style.paddingRight = '';
                }, 100);
            });
        }
    });
</script>
