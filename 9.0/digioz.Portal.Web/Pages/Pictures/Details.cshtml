@page "{id:int?}"
@model DetailsModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Picture Details";
}

<div class="container-fluid my-5">
    <div class="row">
        <div class="col-12">
            @if (Model.Item != null)
            {
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h1 class="card-title mb-4">Picture Details</h1>

                        @if (!string.IsNullOrEmpty(Model.StatusMessage))
                        {
                            <div class="alert alert-@(Model.IsSuccess ? "success" : "danger") alert-dismissible fade show" role="alert">
                                @Model.StatusMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }

                        <div class="mb-4">
                            <div class="border rounded p-3 bg-light text-center position-relative" style="overflow: hidden; width: 100%;" id="imageContainer" title="Click to zoom in">
                                <img src="/img/Pictures/Full/@Model.Item.Filename" 
                                     alt="@Model.Item.Description" 
                                     class="img-fluid" 
                                     id="detailImage"
                                     style="width: 100%; height: auto; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in;" />
                                <small class="text-muted d-block mt-2">Click image to zoom</small>
                            </div>
                            
                            <!-- Navigation Buttons -->
                            <div class="d-flex justify-content-between mt-3">
                                @if (Model.PreviousId.HasValue)
                                {
                                    @if (Model.IsAlbumSource)
                                    {
                                        <a href="/Pictures/Details?id=@Model.PreviousId&source=album&albumId=@Model.AlbumId" class="btn btn-outline-primary">
                                            <i class="bi bi-chevron-left"></i> Previous
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="/Pictures/Details?id=@Model.PreviousId&source=list" class="btn btn-outline-primary">
                                            <i class="bi bi-chevron-left"></i> Previous
                                        </a>
                                    }
                                }
                                else
                                {
                                    <span></span>
                                }
                                
                                @if (Model.NextId.HasValue)
                                {
                                    @if (Model.IsAlbumSource)
                                    {
                                        <a href="/Pictures/Details?id=@Model.NextId&source=album&albumId=@Model.AlbumId" class="btn btn-outline-primary">
                                            Next <i class="bi bi-chevron-right"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="/Pictures/Details?id=@Model.NextId&source=list" class="btn btn-outline-primary">
                                            Next <i class="bi bi-chevron-right"></i>
                                        </a>
                                    }
                                }
                                else
                                {
                                    <span></span>
                                }
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted">Description</h6>
                                <p class="lead">@Model.Item.Description</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Album</h6>
                                @if (Model.Album != null)
                                {
                                    <p class="lead">
                                        <a href="/Pictures/Album?id=@Model.Item.AlbumId">@Model.Album.Name</a>
                                    </p>
                                }
                                else
                                {
                                    <p class="lead">-</p>
                                }
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted">Uploaded By</h6>
                                @if (Model.UploaderProfile != null)
                                {
                                    <p class="lead">
                                        <i class="bi bi-person-circle"></i>
                                        @if (!string.IsNullOrEmpty(Model.UploaderProfile.DisplayName))
                                        {
                                            <a href="/Profile/Details?userId=@Model.UploaderProfile.DisplayName">@Model.UploaderProfile.DisplayName</a>
                                        }
                                        else if (!string.IsNullOrEmpty(Model.UploaderProfile.FirstName) || !string.IsNullOrEmpty(Model.UploaderProfile.LastName))
                                        {
                                            <a href="/Profile/Details?userId=@($"{Model.UploaderProfile.FirstName} {Model.UploaderProfile.LastName}".Trim())">
                                                @($"{Model.UploaderProfile.FirstName} {Model.UploaderProfile.LastName}".Trim())
                                            </a>
                                        }
                                        else
                                        {
                                            <text>Anonymous User</text>
                                        }
                                    </p>
                                }
                                else
                                {
                                    <p class="lead"><i class="bi bi-person-circle"></i> Anonymous User</p>
                                }
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Date Uploaded</h6>
                                <p class="lead">@Model.Item.Timestamp?.ToLocalTime().ToString("MMMM dd, yyyy HH:mm")</p>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-muted">Status</h6>
                                <p class="lead">
                                    @if (Model.Item.Approved)
                                    {
                                        <span class="badge bg-success">Approved</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Pending Approval</span>
                                    }
                                    @if (Model.Item.Visible)
                                    {
                                        <span class="badge bg-info">Visible</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Hidden</span>
                                    }
                                </p>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            @if (Model.IsAlbumSource)
                            {
                                <a href="/Pictures/Album?id=@Model.AlbumId" class="btn btn-secondary">Back to Album</a>
                            }
                            else
                            {
                                <a href="/Pictures/List" class="btn btn-secondary">Back to Gallery</a>
                            }
                            @if (Model.IsOwner || User?.IsInRole("Admin") == true)
                            {
                                <a asp-page="Edit" asp-route-id="@Model.Item.Id" class="btn btn-primary">Edit</a>
                                <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Item.Id" style="display: inline;">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this picture?');">Delete</button>
                                </form>
                            }
                        </div>
                    </div>
                </div>

                @if (Model.AllowComments)
                {
                    <div class="mt-4">
                        @await Component.InvokeAsync("CommentsMenu", new { referenceId = Model.Item.Id.ToString(), referenceType = "/Pictures/Details" })
                    </div>
                }
            }
            else
            {
                <div class="alert alert-warning">Picture not found.</div>
            }
        </div>
    </div>
</div>

<!-- Full Size Image Modal -->
<div class="modal fade" id="zoomModal" tabindex="-1" aria-labelledby="zoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-dark border-secondary">
                <h5 class="modal-title text-light" id="zoomModalLabel">@Model.Item?.Description</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="bg-dark border-bottom border-secondary p-2 d-flex justify-content-center align-items-center">
                <button type="button" class="btn btn-sm btn-outline-light me-2" id="zoomOut">
                    <i class="bi bi-zoom-out"></i> Zoom Out
                </button>
                <span class="text-light mx-3">Zoom: <span id="zoomLevel">100</span>%</span>
                <button type="button" class="btn btn-sm btn-outline-light me-2" id="zoomIn">
                    <i class="bi bi-zoom-in"></i> Zoom In
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="resetZoom">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
                <small class="text-muted ms-4">Click and drag to pan</small>
            </div>
            <div class="modal-body bg-dark p-0" id="zoomContainer" style="height: calc(100vh - 180px); overflow: auto; position: relative;">
                <div id="imageWrapper" style="display: inline-block; min-width: 100%; min-height: 100%; text-align: center;">
                    <img id="zoomImage" 
                         src="/img/Pictures/Full/@Model.Item?.Filename" 
                         alt="@Model.Item?.Description"
                         style="display: inline-block; vertical-align: middle;" 
                         class="zoom-image" />
                </div>
            </div>
            <div class="modal-footer bg-dark border-secondary">
                <small class="text-muted">Use zoom buttons to zoom in/out | Click and drag to pan the image</small>
            </div>
        </div>
    </div>
</div>

<style>
    #detailImage {
        cursor: zoom-in;
    }

    #detailImage:hover {
        opacity: 0.9;
    }

    #zoomContainer {
        background-color: #1a1a1a;
        cursor: grab;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #zoomContainer:active {
        cursor: grabbing;
    }

    #imageWrapper {
        position: relative;
    }

    #zoomImage {
        max-width: none;
        max-height: none;
        user-select: none;
        -webkit-user-drag: none;
        pointer-events: none;
    }

    .zoom-image {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageContainer = document.getElementById('imageContainer');
        const detailImage = document.getElementById('detailImage');
        const zoomModal = document.getElementById('zoomModal');
        const zoomImage = document.getElementById('zoomImage');
        const zoomContainer = document.getElementById('zoomContainer');
        const imageWrapper = document.getElementById('imageWrapper');
        const zoomLevelDisplay = document.getElementById('zoomLevel');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const resetZoomBtn = document.getElementById('resetZoom');
        
        let scale = 1;
        let initialScale = 1;
        let panning = false;
        let startX = 0;
        let startY = 0;
        let scrollLeft = 0;
        let scrollTop = 0;
        
        // Open modal on image click
        if (imageContainer && zoomModal) {
            imageContainer.addEventListener('click', function(e) {
                e.preventDefault();
                const modal = new bootstrap.Modal(zoomModal);
                modal.show();
            });
        }
        
        // Initialize zoom when modal is shown
        if (zoomModal) {
            zoomModal.addEventListener('shown.bs.modal', function() {
                initializeZoom();
            });
        }
        
        function initializeZoom() {
            if (!zoomImage || !zoomContainer) return;
            
            // Wait for image to load
            if (!zoomImage.complete) {
                zoomImage.onload = function() {
                    calculateInitialScale();
                };
            } else {
                calculateInitialScale();
            }
        }
        
        function calculateInitialScale() {
            const containerWidth = zoomContainer.clientWidth;
            const containerHeight = zoomContainer.clientHeight;
            const imageWidth = zoomImage.naturalWidth;
            const imageHeight = zoomImage.naturalHeight;
            
            // Calculate scale to fit the largest dimension
            const widthScale = containerWidth / imageWidth;
            const heightScale = containerHeight / imageHeight;
            
            // Use the smaller scale to ensure the image fits within the viewport
            initialScale = Math.min(widthScale, heightScale, 1);
            scale = initialScale;
            
            // Apply initial scale and center the image
            applyZoom();
            centerImage();
        }
        
        function applyZoom() {
            if (!zoomImage || !imageWrapper) return;
            
            const scaledWidth = zoomImage.naturalWidth * scale;
            const scaledHeight = zoomImage.naturalHeight * scale;
            
            zoomImage.style.width = scaledWidth + 'px';
            zoomImage.style.height = scaledHeight + 'px';
            
            // Update wrapper to accommodate scaled image
            imageWrapper.style.width = scaledWidth + 'px';
            imageWrapper.style.height = scaledHeight + 'px';
            
            updateZoomDisplay();
        }
        
        function centerImage() {
            if (!zoomContainer || !zoomImage) return;
            
            const scaledWidth = zoomImage.naturalWidth * scale;
            const scaledHeight = zoomImage.naturalHeight * scale;
            const containerWidth = zoomContainer.clientWidth;
            const containerHeight = zoomContainer.clientHeight;
            
            // Center horizontally
            if (scaledWidth > containerWidth) {
                zoomContainer.scrollLeft = (scaledWidth - containerWidth) / 2;
            } else {
                zoomContainer.scrollLeft = 0;
            }
            
            // Center vertically
            if (scaledHeight > containerHeight) {
                zoomContainer.scrollTop = (scaledHeight - containerHeight) / 2;
            } else {
                zoomContainer.scrollTop = 0;
            }
        }
        
        function updateZoomDisplay() {
            if (zoomLevelDisplay) {
                zoomLevelDisplay.textContent = Math.round(scale * 100);
            }
        }
        
        function zoomIn() {
            const oldScale = scale;
            scale = Math.min(scale * 1.2, 5); // Max 500%
            
            if (scale !== oldScale) {
                applyZoom();
                maintainScrollPosition(oldScale, scale);
            }
        }
        
        function zoomOut() {
            const oldScale = scale;
            scale = Math.max(scale / 1.2, 0.1); // Min 10%
            
            if (scale !== oldScale) {
                applyZoom();
                maintainScrollPosition(oldScale, scale);
            }
        }
        
        function maintainScrollPosition(oldScale, newScale) {
            if (!zoomContainer) return;
            
            const scaleRatio = newScale / oldScale;
            const containerCenterX = zoomContainer.scrollLeft + zoomContainer.clientWidth / 2;
            const containerCenterY = zoomContainer.scrollTop + zoomContainer.clientHeight / 2;
            
            zoomContainer.scrollLeft = containerCenterX * scaleRatio - zoomContainer.clientWidth / 2;
            zoomContainer.scrollTop = containerCenterY * scaleRatio - zoomContainer.clientHeight / 2;
        }
        
        // Zoom buttons
        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', zoomIn);
        }
        
        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', zoomOut);
        }
        
        // Reset zoom button
        if (resetZoomBtn) {
            resetZoomBtn.addEventListener('click', function() {
                scale = initialScale;
                applyZoom();
                centerImage();
            });
        }
        
        // Pan with mouse drag
        if (zoomContainer) {
            zoomContainer.addEventListener('mousedown', function(e) {
                panning = true;
                startX = e.pageX - zoomContainer.offsetLeft;
                startY = e.pageY - zoomContainer.offsetTop;
                scrollLeft = zoomContainer.scrollLeft;
                scrollTop = zoomContainer.scrollTop;
            });
            
            zoomContainer.addEventListener('mousemove', function(e) {
                if (!panning) return;
                e.preventDefault();
                
                const x = e.pageX - zoomContainer.offsetLeft;
                const y = e.pageY - zoomContainer.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                
                zoomContainer.scrollLeft = scrollLeft - walkX;
                zoomContainer.scrollTop = scrollTop - walkY;
            });
            
            zoomContainer.addEventListener('mouseup', function() {
                panning = false;
            });
            
            zoomContainer.addEventListener('mouseleave', function() {
                panning = false;
            });
        }
        
        // Clean up when modal closes
        if (zoomModal) {
            zoomModal.addEventListener('hidden.bs.modal', function() {
                // Reset zoom state
                scale = 1;
                initialScale = 1;
                panning = false;
                
                setTimeout(function() {
                    // Remove all modal backdrops that might be lingering
                    document.querySelectorAll('.modal-backdrop').forEach(function(backdrop) {
                        backdrop.remove();
                    });
                    
                    // Restore body overflow and remove modal-open class
                    document.body.style.overflow = '';
                    document.body.classList.remove('modal-open');
                    
                    // Remove padding added by Bootstrap for scrollbar compensation
                    document.body.style.paddingRight = '';
                }, 100);
            });
        }
    });
</script>
