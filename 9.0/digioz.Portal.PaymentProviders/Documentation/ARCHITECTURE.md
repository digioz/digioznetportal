# Architecture Overview

## High-Level Architecture

```
???????????????????????????????????????????????????????????????????????
?                    ASP.NET Core Web Application                     ?
?                   (digioz.Portal.Web)                               ?
???????????????????????????????????????????????????????????????????????
?                                                                     ?
?  ???????????????????????????????????????????????????????????????  ?
?  ?  Checkout Page / Payment Processing Service               ?  ?
?  ?                                                            ?  ?
?  ?  - Accept payment form                                     ?  ?
?  ?  - Build PaymentRequest                                   ?  ?
?  ?  - Call IPaymentProviderFactory                           ?  ?
?  ?  - Handle PaymentResponse                                 ?  ?
?  ???????????????????????????????????????????????????????????????  ?
?                         ?                                         ?
?                         ?                                         ?
?  ???????????????????????????????????????????????????????????????  ?
?  ?  Dependency Injection Container                           ?  ?
?  ?                                                            ?  ?
?  ?  - IPaymentProviderFactory (singleton)                    ?  ?
?  ?  - AuthorizeNetProvider (scoped)                          ?  ?
?  ?  - PayPalProvider (scoped)                                ?  ?
?  ?  - [Custom Providers]                                     ?  ?
?  ???????????????????????????????????????????????????????????????  ?
?                         ?                                         ?
?????????????????????????????????????????????????????????????????????
                          ?
                          ?
      ?????????????????????????????????????????????????????
      ?  digioz.Portal.PaymentProviders (Class Library)   ?
      ?                                                   ?
      ?  ?????????????????????????????????????????????   ?
      ?  ?  Abstractions Layer                      ?   ?
      ?  ?  ?????????????????????????????????????????   ?
      ?  ?  - IPaymentProvider (interface)          ?   ?
      ?  ?  - IPaymentProviderFactory (interface)   ?   ?
      ?  ?  - BasePaymentProvider (abstract class)  ?   ?
      ?  ?????????????????????????????????????????????   ?
      ?                  ?                               ?
      ?                  ?                               ?
      ?  ?????????????????????????????????????????????   ?
      ?  ?  Concrete Providers                      ?   ?
      ?  ?  ?????????????????????????????????????????   ?
      ?  ?  ?? AuthorizeNetProvider                 ?   ?
      ?  ?  ?  ?? ProcessPaymentAsync()             ?   ?
      ?  ?  ?  ?? RefundAsync()                     ?   ?
      ?  ?  ?  ?? ValidateConfiguration()           ?   ?
      ?  ?  ?                                        ?   ?
      ?  ?  ?? PayPalProvider                       ?   ?
      ?  ?  ?  ?? ProcessPaymentAsync()             ?   ?
      ?  ?  ?  ?? RefundAsync()                     ?   ?
      ?  ?  ?  ?? ValidateConfiguration()           ?   ?
      ?  ?  ?                                        ?   ?
      ?  ?  ?? [Custom Providers]                   ?   ?
      ?  ?     ?? Implement IPaymentProvider        ?   ?
      ?  ?????????????????????????????????????????????   ?
      ?                  ?                               ?
      ?                  ?                               ?
      ?  ?????????????????????????????????????????????   ?
      ?  ?  Models / Data Transfer Objects          ?   ?
      ?  ?  ?????????????????????????????????????????   ?
      ?  ?  - PaymentRequest (input)                ?   ?
      ?  ?  - PaymentResponse (output)              ?   ?
      ?  ?  - PaymentProviderConfig (settings)      ?   ?
      ?  ?????????????????????????????????????????????   ?
      ?                  ?                               ?
      ?                  ?                               ?
      ?  ?????????????????????????????????????????????   ?
      ?  ?  Factory Implementation                  ?   ?
      ?  ?  ?????????????????????????????????????????   ?
      ?  ?  - PaymentProviderFactory                ?   ?
      ?  ?    ?? CreateProvider(name)               ?   ?
      ?  ?    ?? RegisterProvider(name, type)       ?   ?
      ?  ?    ?? GetAvailableProviders()            ?   ?
      ?  ?    ?? IsProviderAvailable(name)          ?   ?
      ?  ?????????????????????????????????????????????   ?
      ?                  ?                               ?
      ?                  ?                               ?
      ?  ?????????????????????????????????????????????   ?
      ?  ?  Dependency Injection Extensions         ?   ?
      ?  ?  ?????????????????????????????????????????   ?
      ?  ?  - ServiceCollectionExtensions           ?   ?
      ?  ?  - PaymentProviderBuilder (fluent API)   ?   ?
      ?  ?????????????????????????????????????????????   ?
      ?                                                   ?
      ???????????????????????????????????????????????????
                      ?
                      ?
      ???????????????????????????????????????
      ?  External Payment Gateways          ?
      ?                                     ?
      ?  ????????????????????????????????  ?
      ?  ?  Authorize.net               ?  ?
      ?  ?  - AIM API                   ?  ?
      ?  ?  - Sandbox/Production        ?  ?
      ?  ?  - HTTP POST                 ?  ?
      ?  ????????????????????????????????  ?
      ?                                     ?
      ?  ????????????????????????????????  ?
      ?  ?  PayPal                      ?  ?
      ?  ?  - NVP Direct Payment API    ?  ?
      ?  ?  - Sandbox/Production        ?  ?
      ?  ?  - HTTP POST                 ?  ?
      ?  ????????????????????????????????  ?
      ?                                     ?
      ?  ????????????????????????????????  ?
      ?  ?  [Future Providers]          ?  ?
      ?  ?  - Stripe                    ?  ?
      ?  ?  - Square                    ?  ?
      ?  ?  - etc.                      ?  ?
      ?  ????????????????????????????????  ?
      ?                                     ?
      ???????????????????????????????????????
```

## Component Interaction Diagram

```
User Submits Payment Form
        ?
        ?
???????????????????????????????????????
?  Checkout Page Handler              ?
?  - Validate form input              ?
?  - Create PaymentRequest            ?
?  - Inject IPaymentProviderFactory   ?
???????????????????????????????????????
               ?
               ?
???????????????????????????????????????
?  PaymentProviderFactory             ?
?  .CreateProvider(providerName)      ?
???????????????????????????????????????
               ?
        ???????????????
        ?             ?
        ?             ?
   ??????????   ??????????
   ?Authorize?  ? PayPal ?
   ?   .net  ?  ?Provider?
   ??????????   ??????????
        ?             ?
        ???????????????
               ?
               ?
    ????????????????????????
    ? ProcessPaymentAsync  ?
    ? (PaymentRequest)     ?
    ?      ?               ?
    ?      ?? Validate     ?
    ?      ?? Build Request?
    ?      ?? Send HTTP    ?
    ?      ?? Parse Response
    ?      ?? Return Result?
    ????????????????????????
               ?
               ?
    ????????????????????????
    ? PaymentResponse      ?
    ? - IsApproved        ?
    ? - AuthCode          ?
    ? - TransactionId     ?
    ? - Message           ?
    ? - ErrorMessage      ?
    ????????????????????????
               ?
               ?
    ????????????????????????
    ? Checkout Handler     ?
    ? - Save to database   ?
    ? - Handle success/fail?
    ? - Send confirmation  ?
    ? - Redirect           ?
    ????????????????????????
```

## Data Flow Diagram

```
INPUT: PaymentRequest
?? TransactionId: "ORD-123"
?? Amount: 10000 (cents)
?? CardNumber: "****1111"
?? ExpirationMonth: "12"
?? ExpirationYear: "2025"
?? CardCode: "***"
?? CardholderName: "John Doe"
?? BillingAddress: {city, state, zip, country}
?? ShippingAddress: {city, state, zip, country}
?? CustomFields: {key: value}
    ?
    ???? Provider validates request
    ?    - Check required fields
    ?    - Validate card number format
    ?    - Validate amount > 0
    ?
    ???? Provider builds gateway payload
    ?    - Map to provider API format
    ?    - Encrypt sensitive data
    ?    - Add provider-specific fields
    ?
    ???? Provider sends HTTP POST
    ?    - Authorize.net: form-encoded
    ?    - PayPal: NVP format
    ?    - Includes auth credentials
    ?
    ???? Receive gateway response
    ?    - Parse response format
    ?    - Extract key fields
    ?    - Store raw response
    ?
    ???? OUTPUT: PaymentResponse
        ?? IsApproved: true/false
        ?? AuthorizationCode: "ABC123"
        ?? TransactionId: "TXN-456"
        ?? ResponseCode: "1" (provider-specific)
        ?? Message: "Approved"
        ?? ErrorCode: null (if approved)
        ?? ErrorMessage: null (if approved)
        ?? RawResponse: {gateway raw data}
```

## Class Hierarchy

```
IPaymentProvider (Interface)
    ?
    ??? Implemented by BasePaymentProvider (Abstract)
    ?       ?
    ?       ??? AuthorizeNetProvider (Concrete)
    ?       ?   ?? Name: "AuthorizeNet"
    ?       ?   ?? ProcessPaymentAsync()
    ?       ?   ?? RefundAsync()
    ?       ?   ?? ValidateConfiguration()
    ?       ?
    ?       ??? PayPalProvider (Concrete)
    ?       ?   ?? Name: "PayPal"
    ?       ?   ?? ProcessPaymentAsync()
    ?       ?   ?? RefundAsync()
    ?       ?   ?? ValidateConfiguration()
    ?       ?
    ?       ??? [CustomProvider] (Concrete)
    ?           ?? Name: "[CustomName]"
    ?           ?? ProcessPaymentAsync()
    ?           ?? RefundAsync()
    ?           ?? ValidateConfiguration()
    ?
    ??? Created by IPaymentProviderFactory (Interface)
            ?
            ??? Implemented by PaymentProviderFactory (Concrete)
                ?? CreateProvider(name)
                ?? RegisterProvider(name, type)
                ?? GetAvailableProviders()
                ?? IsProviderAvailable(name)

BasePaymentProvider Features:
?? Protected Config: PaymentProviderConfig
?? Protected Initialize(config)
?? Protected ValidatePaymentRequest()
?? Protected CreateErrorResponse()
?? Abstract methods:
   ?? ProcessPaymentAsync()
   ?? RefundAsync()
   ?? ValidateConfiguration()
```

## Dependency Injection Container Setup

```
IServiceCollection (ASP.NET Core)
    ?
    ??? AddPaymentProviders()
        ?
        ??? PaymentProviderBuilder
        ?   ?? AddProvider<AuthorizeNetProvider>("AuthorizeNet")
        ?   ?? AddProvider<PayPalProvider>("PayPal")
        ?   ?? ConfigureProvider("AuthorizeNet", config)
        ?   ?? ConfigureProvider("PayPal", config)
        ?
        ??? Register as Scoped: AuthorizeNetProvider
        ??? Register as Scoped: PayPalProvider
        ?
        ??? Register as Singleton: IPaymentProviderFactory
            ?? PaymentProviderFactory instance

Usage in Service:
    public class MyService
    {
        public MyService(IPaymentProviderFactory factory)
        {
            // Injected automatically by DI container
            var provider = factory.CreateProvider("AuthorizeNet");
        }
    }
```

## File Organization by Concern

```
Abstractions/ (Contracts)
?? IPaymentProvider
?? IPaymentProviderFactory

Models/ (Data Transfer Objects)
?? PaymentRequest
?? PaymentResponse
?? PaymentProviderConfig

Providers/ (Implementations)
?? AuthorizeNetProvider
?? PayPalProvider

DependencyInjection/ (Composition)
?? ServiceCollectionExtensions

Examples/ (Usage Patterns)
?? PaymentProcessingService
?? PaymentProviderStartup
?? MockPaymentProvider

Root/
?? BasePaymentProvider (Base Class)
?? PaymentProviderFactory (Factory)
?? Configuration & Documentation
```

## Request/Response Lifecycle

```
1. CLIENT REQUEST
   User fills checkout form
   ?? Credit card details
   ?? Billing address
   ?? Shipping address
   ?? Amount

2. VALIDATION
   ?? Model validation
   ?? Business logic validation
   ?? Amount verification
   ?? Input sanitization

3. PAYMENT PROCESSING
   ?? Inject IPaymentProviderFactory
   ?? Call CreateProvider("ProviderName")
   ?? Build PaymentRequest
   ?? Call ProcessPaymentAsync(request)
   ?  ?? Validate configuration
   ?  ?? Build provider payload
   ?  ?? Send HTTP request
   ?  ?? Parse response
   ?? Return PaymentResponse

4. RESPONSE HANDLING
   ?? Check IsApproved
   ?? If approved:
   ?  ?? Save order to database
   ?  ?? Save transaction details
   ?  ?? Send confirmation email
   ?  ?? Redirect to success page
   ?? If declined:
      ?? Log failure
      ?? Display error message
      ?? Return to checkout form

5. DATABASE PERSISTENCE
   Order table updated:
   ?? TrxApproved: true/false
   ?? TrxId: transaction ID from provider
   ?? TrxAuthorizationCode: auth code
   ?? TrxMessage: provider message
   ?? TrxResponseCode: provider code
   ?? Full response logged separately

6. AUDIT & MONITORING
   ?? Log all transactions
   ?? Record success/failure metrics
   ?? Alert on unusual patterns
   ?? Maintain compliance audit trail
```

## Extension Points

```
To add a new payment provider:

1. Create Class
   ?? Extends BasePaymentProvider
      ?? Implement Name property
      ?? Implement ProcessPaymentAsync()
      ?? Implement RefundAsync()
      ?? Implement ValidateConfiguration()

2. Register in DI
   ?? AddPaymentProviders(builder =>
      ?? builder.AddProvider<NewProvider>("NewName")
             .ConfigureProvider("NewName", config)

3. Update Configuration
   ?? appsettings.json
      ?? "PaymentProviders": {
             "NewName": { ApiKey, ApiSecret, ... }
         }

4. Use Like Any Other Provider
   ?? factory.CreateProvider("NewName")
      ?? await provider.ProcessPaymentAsync(request)
```

---

This architecture ensures:
- ? Separation of concerns
- ? Loose coupling through interfaces
- ? Easy provider switching
- ? Testability via dependency injection
- ? Extensibility for new providers
- ? Centralized configuration
- ? Consistent error handling
- ? Clear data flow
